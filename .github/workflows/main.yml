name: nymea Raspberry Image

on:
  push:
    branches:
    - master
    - nymea-bullseye
  workflow_dispatch:
    inputs:
      stage:
        description: "landing/experimental"
        required: false

jobs:
  image:
    name: build image
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v3
    - name: setup build environment
      uses: docker/setup-qemu-action@v3.0.0
      with:
        platforms: arm64
    - name: build
      run: |
        ls -la
        sudo apt-get install qemu-user-static
        echo Setting repository to \"${{ github.event.inputs.stage }}\"
        sed -i 's/repository.nymea.io bookworm/repository.nymea.io experimental bookworm/g' nymea/00-sys-tweaks/00-run-chroot.sh
        ./build-docker.sh
        ls -la
    - name: archive artifacts
      uses: actions/upload-artifact@v3.1.3
      with:
        name: nymea image
        path: deploy/image*zip
